<?php /** * Plugin Name: ITS Pretty Filter URLs (WPML-ready) * Description: ЧПУ для фильтров WooCommerce + 301 с параметров, каноникал и noindex для многозначных комбинаций. Совместимо с WPML (EN/ET). * Author: DN * Version: 1.2.0 */ if (!defined('ABSPATH')) exit; /** * ВАЖНО: Плагин рассчитан на атрибуты WooCommerce (pa_*), product_cat и, при наличии, product_brand. * Поддерживает также stock_status (instock). */ /*-------------------- Хелперы окружения --------------------*/ function its_pfu_current_lang() { if (defined('ICL_LANGUAGE_CODE')) return ICL_LANGUAGE_CODE; return ''; } // ЗАМЕНИТЕ старую its_pfu_shop_base_slug_for_lang() на это: function its_pfu_shop_rewrite_prefix_for_lang($lang = null) { if (!$lang) $lang = (defined('ICL_LANGUAGE_CODE') ? ICL_LANGUAGE_CODE : ''); $shop_id = wc_get_page_id('shop'); if ($shop_id <= 0) return 'shop'; if (function_exists('wpml_object_id') || function_exists('wpml_object_id_filter')) { $shop_id = apply_filters('wpml_object_id', $shop_id, 'page', true, $lang); } $shop_url = get_permalink($shop_id); // напр. /lustandlove/en/shop/ $site_path = trim((string) wp_parse_url(home_url('/'), PHP_URL_PATH), '/'); // lustandlove $shop_path = trim((string) wp_parse_url($shop_url, PHP_URL_PATH), '/'); // lustandlove/en/shop // убираем поддиректорию сайта из начала пути if ($site_path && strpos($shop_path, $site_path . '/') === 0) { $shop_path = substr($shop_path, strlen($site_path) + 1); // en/shop } // если языковых папок нет — останется просто 'shop' или 'pood' return $shop_path ?: 'shop'; } /** * Кешируем карту "slug -> [taxonomy, term_id]" для текущего языка. */ function its_pfu_get_term_slug_map() { $lang = its_pfu_current_lang() ?: 'default'; $key = 'its_pfu_terms_map_' . $lang; $map = get_transient($key); if (is_array($map)) return $map; $map = []; // 1) Все продуктовые категории $terms = get_terms(['taxonomy' => 'product_cat', 'hide_empty' => false]); if (!is_wp_error($terms)) { foreach ($terms as $t) $map[$t->slug]['product_cat'][] = $t->term_id; } // 2) Все атрибуты WooCommerce (pa_*) if (function_exists('wc_get_attribute_taxonomies')) { $attrs = wc_get_attribute_taxonomies(); foreach ($attrs as $a) { $tax = wc_attribute_taxonomy_name($a->attribute_name); // pa_color $tms = get_terms(['taxonomy' => $tax, 'hide_empty' => false]); if (!is_wp_error($tms)) { foreach ($tms as $t) $map[$t->slug][$tax][] = $t->term_id; } } } // 3) Популярные бренд-таксономии (опционально) foreach (['product_brand','brand'] as $brand_tax) { if (taxonomy_exists($brand_tax)) { $tms = get_terms(['taxonomy' => $brand_tax, 'hide_empty' => false]); if (!is_wp_error($tms)) { foreach ($tms as $t) $map[$t->slug][$brand_tax][] = $t->term_id; } } } // 4) Служебные синонимы для стока (in-stock) $map['in-stock']['__stock_status'][] = 'instock'; set_transient($key, $map, HOUR_IN_SECONDS); return $map; } /** * Ищем самую глубокую цепочку product_cat по сегментам пути. * Возвращает ['cat_term' => WP_Term|null, 'consumed' => N] */ function its_pfu_match_category_path(array $segments) { $parent = 0; $matched = null; $consumed = 0; foreach ($segments as $i => $slug) { $term = get_terms([ 'taxonomy' => 'product_cat', 'hide_empty' => false, 'slug' => $slug, 'parent' => $parent ]); if (is_wp_error($term) || empty($term)) break; $t = $term[0]; $matched = $t; $parent = $t->term_id; $consumed = $i + 1; } return ['cat_term' => $matched, 'consumed' => $consumed]; } /*-------------------- Рерайт и парсинг --------------------*/ add_filter('query_vars', function ($vars) { $vars[] = 'its_path'; // остаток после /shop|pood/ return $vars; }); function its_pfu_register_rewrites() { $langs = [defined('ICL_LANGUAGE_CODE') ? ICL_LANGUAGE_CODE : '']; if (defined('ICL_SITEPRESS_VERSION') && function_exists('wpml_active_languages')) { $langs = array_keys((array) wpml_active_languages()); } $langs = array_unique(array_filter($langs)); if (empty($langs)) $langs = ['']; foreach ($langs as $l) { $prefix = its_pfu_shop_rewrite_prefix_for_lang($l); // например: 'en/shop' или 'shop' add_rewrite_rule( '^' . preg_quote($prefix, '#') . '/(.+)?$', 'index.php?post_type=product&its_path=$matches[1]', 'top' ); } } add_action('init', 'its_pfu_register_rewrites', 20); add_action('init', 'its_pfu_register_rewrites', 20); register_activation_hook(__FILE__, function () { its_pfu_register_rewrites(); flush_rewrite_rules(); }); register_deactivation_hook(__FILE__, function () { flush_rewrite_rules(); }); /** * Главный парсер: определяет category + превращает хвост в filter_*. */ add_action('parse_request', function ($wp) { if (empty($wp->query_vars['its_path'])) return; $path = trim($wp->query_vars['its_path'], '/'); if ($path === '') return; $segments = array_values(array_filter(explode('/', $path))); // 1) отделяем категорию $catMatch = its_pfu_match_category_path($segments); $catTerm = $catMatch['cat_term']; $rest = array_slice($segments, $catMatch['consumed']); // если это чисто категория без фильтров — позволим штатной логике Woo if ($catTerm && empty($rest)) { $wp->query_vars['product_cat'] = its_pfu_build_cat_path($catTerm); return; } // 2) разбираем фильтровую часть if (empty($rest)) return; // ни категории, ни фильтров — пусть рендерит shop $map = its_pfu_get_term_slug_map(); $filters = []; // taxonomy => array of term slugs $stock = null; foreach ($rest as $piece) { // многозначный атрибут: latex-free+hypoallergenic $alts = array_values(array_filter(explode('+', $piece))); foreach ($alts as $slug) { if (!isset($map[$slug])) { // неизвестный сегмент -> 404 $wp->query_vars['error'] = '404'; return; } // если slug встречается в нескольких таксономиях — это риск коллизии. // Берём первую «не product_cat» (т.к. категория уже распознана). $cands = $map[$slug]; // приоритет: любые pa_* затем brand $prefer = null; foreach ($cands as $tax => $_) { if (strpos($tax, 'pa_') === 0) { $prefer = $tax; break; } } if (!$prefer) { foreach ($cands as $tax => $_) { if ($tax !== 'product_cat') { $prefer = $tax; break; } } } if ($prefer === '__stock_status') { $stock = 'instock'; continue; } if (!$prefer) { $wp->query_vars['error'] = '404'; return; } $filters[$prefer][] = $slug; } } // 3) собираем query vars // Категория — в product_cat (полный путь через «/») if ($catTerm) { $wp->query_vars['product_cat'] = its_pfu_build_cat_path($catTerm); } // Атрибуты — в filter_{attr} foreach ($filters as $tax => $slugs) { $slugs = array_unique($slugs); if (strpos($tax, 'pa_') === 0) { $attr = substr($tax, 3); // pa_color -> color $wp->query_vars["filter_{$attr}"] = implode(',', $slugs); // по умолчанию OR (можно сменить на AND) $wp->query_vars["query_type_{$attr}"] = 'or'; $_GET["filter_{$attr}"] = $wp->query_vars["filter_{$attr}"]; $_GET["query_type_{$attr}"] = 'or'; } else { // другие таксономии (например brand) — WBW обычно тоже умеет в filter_brand $attr = str_replace('product_', '', $tax); $wp->query_vars["filter_{$attr}"] = implode(',', $slugs); $_GET["filter_{$attr}"] = $wp->query_vars["filter_{$attr}"]; } } // Сток if ($stock === 'instock') { $wp->query_vars['stock_status'] = 'instock'; $_GET['stock_status'] = 'instock'; } // Убедимся, что это магазинный запрос $wp->query_vars['post_type'] = 'product'; }, 11); /** * Собираем «полный путь» категории (parent/child/...) */ function its_pfu_build_cat_path(WP_Term $leaf) { $segments = [$leaf->slug]; $p = $leaf->parent; while ($p) { $t = get_term($p, 'product_cat'); if (!$t || is_wp_error($t)) break; array_unshift($segments, $t->slug); $p = $t->parent; } return implode('/', $segments); } /*-------------------- 301 с параметров на ЧПУ --------------------*/ function its_pfu_build_pretty_url_from_query() { // Берём URL магазина в текущем языке $lang = defined('ICL_LANGUAGE_CODE') ? ICL_LANGUAGE_CODE : ''; $shop_id = wc_get_page_id('shop'); if ($shop_id <= 0) return false; if (function_exists('wpml_object_id') || function_exists('wpml_object_id_filter')) { $shop_id = apply_filters('wpml_object_id', $shop_id, 'page', true, $lang); } $base_url = trailingslashit(get_permalink($shop_id)); // учтены /lustandlove/ и /en|et/ // Категория $cat_path = ''; if (is_product_category()) { $term = get_queried_object(); if ($term instanceof WP_Term) $cat_path = its_pfu_build_cat_path($term); } // Собираем «хвост» фильтров как и раньше... $pieces = []; $filters = []; if (function_exists('wc_get_attribute_taxonomies')) { foreach (wc_get_attribute_taxonomies() as $a) { $attr = $a->attribute_name; $key = "filter_{$attr}"; if (!empty($_GET[$key])) { $vals = array_values(array_filter(explode(',', sanitize_text_field($_GET[$key])))); if ($vals) $filters["pa_{$attr}"] = $vals; } } } foreach (['brand','product_brand'] as $alt) { $key = "filter_{$alt}"; if (!empty($_GET[$key])) { $vals = array_values(array_filter(explode(',', sanitize_text_field($_GET[$key])))); if ($vals) $filters[$alt === 'brand' ? 'brand' : 'product_brand'] = $vals; } } if (!empty($_GET['stock_status']) && $_GET['stock_status'] === 'instock') { $pieces[] = 'in-stock'; } foreach ($filters as $tax => $vals) { $vals = array_map('sanitize_title', $vals); if (!$vals) continue; $pieces[] = count($vals) > 1 ? implode('+', $vals) : $vals[0]; } if (!$pieces) return false; $pretty = $base_url; if ($cat_path) $pretty .= trailingslashit($cat_path); $pretty .= implode('/', $pieces) . '/'; return $pretty; // уже полный абсолютный URL с /lustandlove/ и /en|et/ } add_action('template_redirect', function () { if (is_admin()) return; if (!(is_shop() || is_product_category())) return; $has_filters = false; foreach ($_GET as $k => $v) { if (strpos($k, 'filter_') === 0 && $v !== '') { $has_filters = true; break; } } if (!$has_filters && isset($_GET['stock_status'])) $has_filters = true; if (!$has_filters) return; $pretty = its_pfu_build_pretty_url_from_query(); if (!$pretty) return; global $wp; $current = trailingslashit(home_url($wp->request)); // учитывает /lustandlove/ и /en|et/ if (trailingslashit($pretty) !== $current) { wp_safe_redirect($pretty, 301); exit; } }); /*-------------------- Каноникал и авто-noindex --------------------*/ function its_pfu_is_multivalue_combo() { // noindex, если где-то выбрано >1 значения if (function_exists('wc_get_attribute_taxonomies')) { foreach (wc_get_attribute_taxonomies() as $a) { $key = "filter_{$a->attribute_name}"; if (!empty($_GET[$key]) && strpos($_GET[$key], ',') !== false) return true; } } // также считаем 'in-stock+...' невозможным, тут ок return false; } add_action('wp_head', function () { if (!(is_shop() || is_product_category())) return; global $wp; $canonical = trailingslashit(home_url($wp->request)); echo '<link rel="canonical" href="' . esc_url($canonical) . "\" />\n"; if (its_pfu_is_multivalue_combo()) { echo "<meta name=\"robots\" content=\"noindex,follow\" />\n"; } }, 20); /*-------------------- SEO-заголовки (Yoast / fallback) --------------------*/ add_filter('pre_get_document_title', 'its_pfu_dynamic_title', 20); add_filter('wpseo_title', 'its_pfu_dynamic_title', 20); function its_pfu_dynamic_title($title) { if (!(is_shop() || is_product_category())) return $title; $parts = []; // Категория if (is_product_category()) { $term = get_queried_object(); if ($term instanceof WP_Term) $parts[] = $term->name; } else { $parts[] = get_the_title(wc_get_page_id('shop')); } // Фильтры (человекочитаемо из slug) $labelize = function($slug) { $slug = str_replace(['-','_'], ' ', $slug); return mb_convert_case($slug, MB_CASE_TITLE, 'UTF-8'); }; // С stock_status if (!empty($_GET['stock_status']) && $_GET['stock_status'] === 'instock') { $parts[] = __('In Stock', 'woocommerce'); } if (function_exists('wc_get_attribute_taxonomies')) { foreach (wc_get_attribute_taxonomies() as $a) { $key = "filter_{$a->attribute_name}"; if (!empty($_GET[$key])) { $vals = array_map($labelize, array_filter(explode(',', sanitize_text_field($_GET[$key])))); if ($vals) $parts[] = implode(' / ', $vals); } } } foreach (['brand','product_brand'] as $alt) { $key = "filter_{$alt}"; if (!empty($_GET[$key])) { $vals = array_map($labelize, array_filter(explode(',', sanitize_text_field($_GET[$key])))); if ($vals) $parts[] = implode(' / ', $vals); } } $site = get_bloginfo('name'); return implode(' — ', $parts) . ' | ' . $site; } /*-------------------- Сервис --------------------*/ // Сброс кеша карты терминов при изменениях add_action('edited_terms', function ($term_id, $tt_id, $taxonomy) { if (strpos($taxonomy, 'pa_') === 0 || $taxonomy === 'product_cat' || $taxonomy === 'product_brand' || $taxonomy === 'brand') { global $sitepress; if (isset($sitepress) && method_exists($sitepress, 'get_active_languages')) { foreach ($sitepress->get_active_languages() as $code => $_) { delete_transient('its_pfu_terms_map_' . $code); } } delete_transient('its_pfu_terms_map_default'); } }, 10, 3);